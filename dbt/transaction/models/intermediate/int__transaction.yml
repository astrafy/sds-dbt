version: 2

models:
  - name: int__transaction
    description: "Intermediate table for product details, enriched with currency text"

unit_tests:
  - name: test_int_transaction
    model: int__transaction
    overrides:
      macros:
        # Override is_incremental for testing purposes
        is_incremental: true

        # Directly mock the value of max_partition_date. 
        # Simulate the result of the max_partition_date query returning '2025-03-03'.
        # Since we're mocking the date directly, we don't need to use `run_query` or `set` statements.
        incremental_filter: "2025-03-03"

    given:
      - input: ref('stg__transaction')
        rows:
          - transaction_id: 1001
            customer_id: 2001
            product_id: 3001
            currency: "USD"
            transaction_amount: 150.00
            transaction_date: "2025-03-05"
            ingested_date: "2025-03-06"
          - transaction_id: 1002
            customer_id: 2002
            product_id: 3002
            currency: "EUR"
            transaction_amount: 130.00
            transaction_date: "2025-03-05"
            ingested_date: "2025-03-06"
      - input: this
        rows:
          - transaction_id: 1001
            customer_id: 2001
            product_id: 3001
            currency: "USD"
            transaction_amount: 140.00
            transaction_date: "2025-03-05"
            ingested_date: "2025-03-06"
    expect:
      rows:
        - transaction_id: 1001
          customer_id: 2001
          product_id: 3001
          currency: "USD"
          transaction_amount: 150.00
          transaction_date: "2025-03-05"
          ingested_date: "2025-03-06"
        - transaction_id: 1002
          customer_id: 2002
          product_id: 3002
          currency: "EUR"
          transaction_amount: 130.00
          transaction_date: "2025-03-05"
          ingested_date: "2025-03-06"
